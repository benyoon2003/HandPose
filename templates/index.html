<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Gesture Login</title>
    <style>
        /* Style for the webcam video container */
        #video-container {
            position: relative;
            display: inline-block;
        }

        /* Style the canvas for visualizing gestures */
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            pointer-events: none; /* Allow interaction with video behind canvas */
        }

        /* Style for messages (overlay over video) */
        #messageDiv, #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            z-index: 3;
            display: none;
        }

        #messageDiv {
            padding: 10px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
        }

        /* Style for loading indicator */
        #loading {
            color: blue; /* Blue for loading message */
        }

        /* Green for success (Access Granted) */
        .success {
            background-color: green;
        }

        /* Red for failure (Access Denied) */
        .error {
            background-color: red;
        }
    </style>
</head>
<body>
    <h1>Hand Gesture Login</h1>

    <!-- Container for the webcam video feed and overlay messages -->
    <div id="video-container">
        <video id="webcam" autoplay playsinline></video>

        <!-- Canvas for drawing normalized keypoints -->
        <canvas id="canvas"></canvas>

        <!-- Loading Indicator -->
        <div id="loading">Loading...</div>

        <!-- Message for gesture status (verification or gesture saved) -->
        <div id="messageDiv"></div>
    </div>

    <br>
    <button onclick="sendToServer('/capture-gesture')">Save Gesture</button>
    <button onclick="sendToServer('/verify-gesture')">Verify Gesture</button>

    <script>
        const webcam = document.getElementById('webcam');
        const messageDiv = document.getElementById('messageDiv');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const loadingIndicator = document.getElementById('loading'); // Loading div

        // Get access to webcam
        navigator.mediaDevices.getUserMedia({ video: true })
            .then((stream) => {
                webcam.srcObject = stream;
                // Adjust canvas size to match webcam stream
                webcam.onloadedmetadata = () => {
                    canvas.width = webcam.videoWidth;
                    canvas.height = webcam.videoHeight;
                };
            })
            .catch((err) => {
                console.error("Error accessing webcam: ", err);
            });

        async function sendToServer(endpoint) {
            const videoCanvas = document.createElement('canvas');
            videoCanvas.width = webcam.videoWidth;
            videoCanvas.height = webcam.videoHeight;
            videoCanvas.getContext('2d').drawImage(webcam, 0, 0);

            // Show the loading indicator
            showLoadingIndicator(true);

            videoCanvas.toBlob(async (blob) => {
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        body: blob,
                        headers: {
                            'Content-Type': 'application/octet-stream'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Server responded with status ${response.status}`);
                    }

                    const result = await response.json(); // Ensure server returns JSON
                    console.log('Server Response:', result);

                    // Show message based on the server response
                    if (result.status) {
                        showMessage(result.status, result.status.includes('Denied'));
                    } else {
                        showMessage('Unknown error occurred.', false);
                    }

                    // If keypoints are available, draw them on the canvas
                    if (result.keypoints) {
                        drawKeypointsOnCanvas(result.keypoints);
                    }
                } catch (error) {
                    console.error('Error sending gesture:', error);
                    showMessage('⚠️ Error: ' + error.message, false);
                } finally {
                    // Hide the loading indicator once the request is complete
                    showLoadingIndicator(false);
                }
            }, 'image/jpeg');
        }

        function drawKeypointsOnCanvas(keypoints) {
            // Clear previous keypoints
            context.clearRect(0, 0, canvas.width, canvas.height);

            context.fillStyle = 'red';
            for (let i = 0; i < keypoints.length; i += 2) {
                const norm_x = keypoints[i];
                const norm_y = keypoints[i + 1];

                // Normalize to canvas dimensions (using video width/height)
                const x = norm_x * canvas.width;
                const y = norm_y * canvas.height;

                // Draw a small circle at each keypoint
                context.beginPath();
                context.arc(x, y, 5, 0, 2 * Math.PI);
                context.fill();
            }
        }

        function showLoadingIndicator(show) {
            if (show) {
                loadingIndicator.style.display = 'block';
                messageDiv.style.display = 'none'; // Hide message during loading
            } else {
                loadingIndicator.style.display = 'none';
            }
        }

        function showMessage(message, isError) {
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            messageDiv.className = isError ? 'error' : 'success'; // Add error or success class
        }
    </script>
</body>
</html>
